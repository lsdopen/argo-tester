name: Tag Version

on:
  push:
    branches:
      - main
      - develop

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get current tag
      id: current_tag
      run: |
        git fetch --tags
        TAG=$(git describe --tags --abbrev=0)
        echo "::set-output name=TAG::$TAG"

    - name: Bump version
      id: bump_version
      run: |
        # Extract the current version or set to v0.0.0 if no tags exist
        CURRENT_TAG="${{ steps.current_tag.outputs.TAG }}"
        if [ -z "$CURRENT_TAG" ]; then
          CURRENT_TAG="v0.0.0"
        fi

        # Split version into components
        IFS='.' read -r -a VERSION_PARTS <<< "${CURRENT_TAG:1}"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}

        # Increment the patch version
        PATCH=$((PATCH + 1))

        # Create new tag based on branch
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
        elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          NEW_TAG="v$MAJOR.$MINOR.$PATCH-dev"
        fi

        echo "New tag: $NEW_TAG"
        echo "::set-output name=NEW_TAG::$NEW_TAG"

    - name: Create new tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.bump_version.outputs.NEW_TAG }}
        git push origin ${{ steps.bump_version.outputs.NEW_TAG }}
